<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Estoque</title>
  <link rel="stylesheet" href="../CSS/estoque_styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestão de Estoque</h1>
      <p>Organize e acompanhe seus produtos, fornecedores e movimentações.</p>
    </header>

    <main>
      <!-- Cadastro de Produtos -->
      <section class="card">
        <h2>Cadastro de Produtos</h2>
        <form id="product-form">
          <label>Nome do Produto:
            <input type="text" id="product-name" placeholder="Ex.: Notebook" required />
          </label>
          <label>Descrição:
            <textarea id="product-description" placeholder="Ex.: Notebook com 16GB RAM"></textarea>
          </label>
          <label>Categoria:
            <input type="text" id="product-category" placeholder="Ex.: Eletrônicos" />
          </label>
          <label>Marca:
            <input type="text" id="product-brand" placeholder="Ex.: Dell" />
          </label>
          <label>Modelo:
            <input type="text" id="product-model" placeholder="Ex.: Inspiron 15" />
          </label>
          <label>Especificações Técnicas:
            <textarea id="product-specs" placeholder="Ex.: Processador i7, 512GB SSD"></textarea>
          </label>
          <label>Fornecedor:
            <select id="product-supplier" required>
              <option value="" disabled selected>Selecione um fornecedor</option>
            </select>
          </label>
          <button type="submit">Cadastrar Produto</button>
        </form>
      </section>

      <!-- Controle de Estoque -->
      <section class="card">
        <h2>Controle de Estoque</h2>
        <form id="stock-form">
          <label>Produto: 
            <input type="text" id="stock-product" placeholder="Ex.: Notebook Dell" required />
          </label>
          <label>Quantidade: 
            <input type="number" id="stock-quantity" placeholder="Ex.: 50" required />
          </label>
          <label>Valor (R$): 
            <input type="number" id="stock-value" placeholder="Ex.: 2500.00" required />
          </label>
          <label>Tipo de Movimentação:
            <select id="movement-type">
              <option value="entrada">Entrada</option>
              <option value="saida">Saída</option>
            </select>
          </label>
          <button type="submit">Registrar Movimentação</button>
        </form>
        <p class="alert">⚠️ Atenção: Estoque baixo para *Produto X*.</p>
      </section>

      <!-- Lista de Produtos no Estoque -->
      <section class="card">
        <h2>Produtos no Estoque</h2>
        <table id="stock-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Quantidade</th>
              <th>Valor</th>
              <th>Data de Entrada</th>
              <th>Data de Saída</th>
              <th>Editar</th>
              <th>Excluir</th>
            </tr>
          </thead>
          <tbody>
            <!-- Os produtos serão inseridos dinamicamente aqui -->
          </tbody>
        </table>
      </section>

      <!-- Histórico de Movimentações -->
      <section class="card">
        <h2>Histórico de Movimentações</h2>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Produto</th>
              <th>Responsável</th>
              <th>Quantidade</th>
              <th>Valor</th>
              <th>Tipo</th>
            </tr>
          </thead>
          <tbody id="movement-history">
            <!-- Histórico de movimentações será inserido dinamicamente -->
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    const productForm = document.getElementById("product-form");
    const stockForm = document.getElementById("stock-form");
    const stockTable = document.getElementById("stock-table").getElementsByTagName("tbody")[0];
    const movementHistory = document.getElementById("movement-history");
    const supplierSelect = document.getElementById("product-supplier");

    let movements = [];

    

   // Função para registrar movimentação de estoque
stockForm.addEventListener("submit", async function(event) {
  event.preventDefault();

  const productId = document.getElementById("stock-product").value; // Certifique-se de que o ID do produto está sendo usado
  const quantity = parseInt(document.getElementById("stock-quantity").value);
  const value = parseFloat(document.getElementById("stock-value").value);
  const type = document.getElementById("movement-type").value;
  const responsible = "Admin"; // Substitua pelo ID do responsável

  const response = await fetch('/produtos/movimentacao', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      id_produto: productId,
      tipo_movimentacao: type,
      quantidade: quantity,
      valor: value,
      responsavel: responsible
    })
  });

  if (response.ok) {
    alert("Movimentação registrada com sucesso");
    displayMovementHistory();
    displayProducts();
  } else {
    alert("Erro ao registrar movimentação");
  }
});


    // Função para exibir histórico de movimentações
    function displayMovementHistory() {
      movementHistory.innerHTML = "";
      movements.forEach((movement) => {
        const row = movementHistory.insertRow();
        row.innerHTML = `
          <td>${movement.entryDate || movement.exitDate || "N/A"}</td>
          <td>${movement.productName}</td>
          <td>${movement.responsible}</td>
          <td>${movement.quantity}</td>
          <td>${movement.value ? `R$ ${movement.value.toFixed(2)}` : "N/A"}</td>
          <td>${movement.type}</td>
        `;
      });
    }

    // Função para exibir produtos no estoque
    function displayProducts() {
      stockTable.innerHTML = "";
      movements.forEach((movement) => {
        const row = stockTable.insertRow();
        row.innerHTML = `
          <td>${movement.productName}</td>
          <td>${movement.quantity}</td>
          <td>R$ ${movement.value ? movement.value.toFixed(2) : "N/A"}</td>
          <td>${movement.entryDate || "N/A"}</td>
          <td>${movement.exitDate || "N/A"}</td>
          <td><button onclick="editProduct('${movement.productName}')">Editar</button></td>
          <td><button onclick="deleteProduct('${movement.productName}')">Excluir</button></td>
        `;
      });
    }

    // Função para editar produto
    function editProduct(productName) {
      const movement = movements.find((m) => m.productName === productName);
      if (movement) {
        document.getElementById("stock-product").value = movement.productName;
        document.getElementById("stock-quantity").value = movement.quantity;
        document.getElementById("stock-value").value = movement.value;
        document.getElementById("movement-type").value = movement.type;
      }
    }

    // Função para excluir produto
    function deleteProduct(productName) {
      movements = movements.filter((m) => m.productName !== productName);
      displayProducts();
    }
  </script>
</body>
</html>
