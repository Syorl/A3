<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Pedidos</title>
  <link rel="stylesheet" href="../CSS/pedidos_styles.css">
</head>
<body>
  <h1>Gerenciar Pedidos</h1>
  <form id="pedidoForm">
    <label for="cliente">Cliente:</label>
    <input list="clienteList" id="cliente" name="cliente" required>
    <datalist id="clienteList">
      <!-- Clientes serão inseridos dinamicamente aqui -->
    </datalist>

    <label for="vendedor">Vendedor:</label>
    <input list="vendedorList" id="vendedor" name="vendedor" required>
    <datalist id="vendedorList">
      <!-- Vendedores serão inseridos dinamicamente aqui -->
    </datalist>

    <label for="produto">Produto:</label>
    <input list="produtoList" id="produto" name="produto" required>
    <datalist id="produtoList">
      <!-- Produtos serão inseridos dinamicamente aqui -->
    </datalist>

    <label for="quantidade">Quantidade:</label>
    <input type="number" id="quantidade" name="quantidade" required>

    <label for="valor">Valor:</label>
    <input type="number" id="valor" name="valor" required step="0.01">

    <button type="submit">Registrar Pedido</button>
    <button type="button" id="updatePedido">Atualizar Pedido</button>
    <button type="button" id="deletePedido">Cancelar Pedido</button>
  </form>

  <h2>Lista de Pedidos</h2>
  <table id="pedidosTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Vendedor</th>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody>
      <!-- Pedidos serão inseridos dinamicamente aqui -->
    </tbody>
  </table>

  <script>
    const pedidoForm = document.getElementById('pedidoForm');
    const updatePedidoBtn = document.getElementById('updatePedido');
    const deletePedidoBtn = document.getElementById('deletePedido');
    const pedidosTable = document.getElementById('pedidosTable').getElementsByTagName('tbody')[0];
    const clienteSelect = document.getElementById('cliente');
    const vendedorSelect = document.getElementById('vendedor');
    const produtoSelect = document.getElementById('produto');

    let selectedPedidoId = null;

    // Função para carregar clientes
    async function loadClientes() {
      const response = await fetch('/clientes');
      const clientes = await response.json();
      const clienteList = document.getElementById('clienteList');
      clienteList.innerHTML = '';
      clientes.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.nome;
        clienteList.appendChild(option);
      });
    }

    // Função para carregar vendedores
    async function loadVendedores() {
      const response = await fetch('/vendedores');
      const vendedores = await response.json();
      const vendedorList = document.getElementById('vendedorList');
      vendedorList.innerHTML = '';
      vendedores.forEach(vendedor => {
        const option = document.createElement('option');
        option.value = vendedor.nome;
        vendedorList.appendChild(option);
      });
    }

    // Função para carregar produtos
    async function loadProdutos() {
      const response = await fetch('/produtos');
      const produtos = await response.json();
      const produtoList = document.getElementById('produtoList');
      produtoList.innerHTML = '';
      produtos.forEach(produto => {
        const option = document.createElement('option');
        option.value = `${produto.nome} (Quantidade: ${produto.quantidade})`;
        produtoList.appendChild(option);
      });
    }

    // Função para registrar pedido
    pedidoForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const clienteNome = document.getElementById('cliente').value;
      const vendedorNome = document.getElementById('vendedor').value;
      const produtoNome = document.getElementById('produto').value;
      const quantidade = document.getElementById('quantidade').value;
      const valor = document.getElementById('valor').value;

      const cliente = await fetch(`/clientes?nome=${clienteNome}`).then(res => res.json());
      const vendedor = await fetch(`/vendedores?nome=${vendedorNome}`).then(res => res.json());
      const produto = await fetch(`/produtos?nome=${produtoNome}`).then(res => res.json());

      if (cliente.length && vendedor.length && produto.length) {
        const newPedido = {
          id_cliente: cliente[0].id_cliente,
          id_vendedor: vendedor[0].id_vendedor,
          id_produto: produto[0].id,
          quantidade,
          valor
        };

        const response = await fetch('/pedidos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newPedido)
        });

        if (response.ok) {
          alert('Pedido registrado com sucesso');
          displayPedidos();
          pedidoForm.reset();
        } else {
          alert('Erro ao registrar pedido');
        }
      } else {
        alert('Cliente, vendedor ou produto não encontrados');
      }
    });

    // Função para atualizar pedido
    updatePedidoBtn.addEventListener('click', async () => {
      if (selectedPedidoId) {
        const clienteNome = document.getElementById('cliente').value;
        const vendedorNome = document.getElementById('vendedor').value;
        const produtoNome = document.getElementById('produto').value;
        const quantidade = document.getElementById('quantidade').value;
        const valor = document.getElementById('valor').value;

        const cliente = await fetch(`/clientes?nome=${clienteNome}`).then(res => res.json());
        const vendedor = await fetch(`/vendedores?nome=${vendedorNome}`).then(res => res.json());
        const produto = await fetch(`/produtos?nome=${produtoNome}`).then(res => res.json());

        if (cliente.length && vendedor.length && produto.length) {
          const updatedPedido = {
            id_cliente: cliente[0].id_cliente,
            id_vendedor: vendedor[0].id_vendedor,
            id_produto: produto[0].id,
            quantidade,
            valor
          };

          const response = await fetch(`/pedidos/${selectedPedidoId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedPedido)
          });

          if (response.ok) {
            alert('Pedido atualizado com sucesso');
            displayPedidos();
            pedidoForm.reset();
            selectedPedidoId = null;
          } else {
            alert('Erro ao atualizar pedido');
          }
        } else {
          alert('Cliente, vendedor ou produto não encontrados');
        }
      } else {
        alert('Selecione um pedido para atualizar');
      }
    });

    // Função para cancelar pedido
    deletePedidoBtn.addEventListener('click', async () => {
      if (selectedPedidoId) {
        const response = await fetch(`/pedidos/${selectedPedidoId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Pedido cancelado com sucesso');
          displayPedidos();
          pedidoForm.reset();
          selectedPedidoId = null;
        } else {
          alert('Erro ao cancelar pedido');
        }
      } else {
        alert('Selecione um pedido para cancelar');
      }
    });

    // Função para exibir pedidos na tabela
    async function displayPedidos() {
      const response = await fetch('/pedidos');
      const pedidos = await response.json();

      pedidosTable.innerHTML = '';

      pedidos.forEach(pedido => {
        const row = pedidosTable.insertRow();
        row.addEventListener('click', () => {
          selectedPedidoId = pedido.id_pedido;
          document.getElementById('cliente').value = pedido.cliente;
          document.getElementById('vendedor').value = pedido.vendedor;
          document.getElementById('produto').value = pedido.produto;
          document.getElementById('quantidade').value = pedido.quantidade;
          document.getElementById('valor').value = pedido.valor;
        });

        row.insertCell(0).textContent = pedido.id_pedido;
        row.insertCell(1).textContent = pedido.cliente;
        row.insertCell(2).textContent = pedido.vendedor;
        row.insertCell(3).textContent = pedido.produto;
        row.insertCell(4).textContent = pedido.quantidade;
        row.insertCell(5).textContent = pedido.valor;
      });
    }

    // Inicializa a lista de clientes, vendedores e pedidos ao carregar a página
    window.onload = function() {
      loadClientes();
      loadVendedores();
      loadProdutos();
      displayPedidos();
    };
  </script>
</body>
</html>